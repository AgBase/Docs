====================================
**Combining Gene Association Files**
====================================

This tool can be used to combine the gene association file (GAF) outputs from GOanna and InterProScan. 

The tool accepts two input files:

1. GOanna GAF output
2. InterProScan GAF output

.. Note:: 

    InterProScan itself does not produce a GAF file. The    `AgBase InterProScan container <https://hub.docker.com/r/agbase/interproscan>`_ parses the XML output from InterProScan to produce the GAF file.

**Combine GAFs on CyVerse**
===========================

**Accessing GOanna in the Discovery Environment**
-------------------------------------------------

1. `Create an account on CyVerse <user.cyverse.org>`_ (free)
2. Open the CyVerse Discovery Environment (DE) and login with your CyVerse credentials.
3. If you are new to the Discovery Environment (DE) the user guide can be found `here <https://learning.cyverse.org/projects/discovery-environment-guide/en/latest/>`_.

4. Click on the ‘Data’ button at the left side of the screen to access your files/folders. Upload your data to the DE.
5. To access the `combine_GAFs 1.0 <https://de.cyverse.org/de/?type=apps&app-id=d8219400-7b47-11e9-a097-008cfa5ae621&system-id=de>`_ app click on the ‘Apps’ button at the left side of the DE. 
6. Search for 'combine" in the search bar at the top of the ‘apps’ window (see below). The contents of the folder will appear in the main pane of the window. The combine_GAFs app is called ‘combine_GAFs 1.0’; click on the name to open the app.

|find_combine_gafs|


.. admonition:: Find Apps Easily with 'Communities'

    The GOanna 2.0 app belongs to the 'i5k' and 'AgBase' communties. You can join either of these communities and they will appear in the left-hand pane of your 'Apps' window (see above). 

    To join a community click on the person icon in the top-right corner of the Discovery Environment window and select 'Communities'. In the 'Communities' window choose 'all communities' from the drop-down list. A list of communities will appear in the main pane of this window. Select the one you wish to join by clicking on it and then clicking on the 'join' button.

**Using the Combine_GAFs App**
------------------------------
**Launching the App**
^^^^^^^^^^^^^^^^^^^^^

|combine_gafs|


**Analysis Name: Combine_GAFs_1.0_analysis1:**
This menu is used to name the job you will run so that you can find it later.
Analysis Name: The default name is "Combine_GAFs_1.0_analysis1". We recommend changing the 'analysis1' portion of this to reflect the data you are running.

**Comments:**
(Optional) You can add additional information in the comments section to distinguish your analyses further.

**Select output folder:**
This is where your results will be placed. The default (recommended) is your 'analyses' folder.

**Retain Inputs:**
Enabling this flag will copy all the input files into the analysis result folder. 

.. WARNING:: 

    Selecting this option will rapidly consume your allocated space. It is not recommended. Your inputs will always remain available in the folder in which you stored them.

**Input**
^^^^^^^^^
**GOanna GAF Output File:** This is the GAF file generated by a GOanna analysis.

**InterProScan XML Parser GAF Output File:** This is the GAF output file generated by an InterProScan XML Parser analysis. InterProScan itself does not produce this file, though some IntperProScan apps include this analysis. If it is missing from your InterProScan output you can generate it using the InterProScan XML Parser app.

**Output**
^^^^^^^^^^
**Output File Basename:** This will be the prefix for your output file (a .tsv extension will be added).

If your analysis fails please check the 'condor_stderr' file in the analysis output 'logs' folder. If that doesn't clarify the problem contact us at agbase@email.arizona.edu or support@cyverse.org.


Combine GAFs on the Command Line
==================================

**Container Technologies**
--------------------------
GOanna is provided as a Docker container. 

A container is a standard unit of software that packages up code and all its dependencies so the application runs quickly and reliably from one computing environment to another.

There are two major containerization technologies: **Docker** and **Singularity**. 

Docker containers can be run with either technology.


Combine GAFs using Docker
-------------------------

.. admonition:: About Docker

    - Docker must be installed on the computer you wish to use for your analysis.
    - To run Docker you must have ‘root’ permissions (or use sudo).
    - Docker will run all containers as ‘root’. This makes Docker incompatible with HPC systems (see Singularity below).
    - Docker can be run on your local computer, a server, a cloud virtual machine (such as CyVerse Atmosphere) etc. Docker can be installed quickly on an Atmosphere instance by typing ‘ezd’.
    - For more information on installing Docker on other systems see this tutorial:  `Installing Docker on your machine <https://learning.cyverse.org/projects/container_camp_workshop_2019/en/latest/docker/dockerintro.html>`_.


**Getting the Combine GAFs container**
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
The Combine GAFs tool is available as a Docker container on Docker Hub: 
`GOanna container <https://hub.docker.com/r/agbase/combine_gafs>`_ 

The container can be pulled with this command: 

.. code-block:: bash

    docker pull agbase/combine_gafs:1.0

.. admonition:: Remember

    You must have root permissions or use sudo, like so:

    sudo docker pull agbase/combine_gafs:1.0

**Running Combine GAFs with Data**
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Combine GAFs has three parameters:

.. code-block:: bash

    -i InterProScan XML Parser GAF output
    -g GOanna GAF output
    -o output file basename

**Example Command**
"""""""""""""""""""

.. code-block:: none

    sudo docker run \
    --rm \
    -v $(pwd):/work-dir \
    agbase/combine_gafs:1.0 \
    -i CFLO_1.fa_gaf.txt \
    -g clfo1_v_insecta_goanna_gaf.tsv \
    -o complete_gaf 


**Breakdown of Command**
""""""""""""""""""""""""

**sudo docker run:** tells docker to run

**--rm:** removes the container when the analysis has finished. The image will remain for future use.

**-v $(pwd):/work-dir:** mounts my current working directory on the host machine to '/work-dir' in the container

**agbase/combine_gafs:1.0:** the name of the Docker image to use

.. tip::

    All the options supplied after the image name are Combine_GAFs options

**-i CFLO_1.fa_gaf.txt:** InterProScan XML Parser GAF output file.

**-g clfo1_v_insecta_goanna_gaf.tsv:** GOanna GAF output file.

**-o complete_gaf:** output file basename--a .tsv extension will be added 


**Combine GAFs using Singularity**
----------------------------------


.. admonition:: About Singularity

    - does not require ‘root’ permissions
    - runs all containers as the user that is logged into the host machine
    - HPC systems are likely to have Singularity installed and are unlikely to object if asked to install it (no guarantees).
    - can be run on any machine where is is installed
    - more information about `installing Singularity <https://singularity.lbl.gov/docs-installation>`_
    - This tool was tested using Singularity 3.0. Users with Singularity 2.x will need to modify the commands accordingly.


.. admonition:: HPC Job Schedulers

    Although Singularity can be installed on any computer this documentation assumes it will be run on an HPC system. The tool was tested on a PBSPro system and the job submission scripts below reflect that. Submission scripts will need to be modified for use with other job scheduler systems.

**Getting the Combine GAFs Container**
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
The GOanna tool is available as a Docker container on Docker Hub: 
`GOanna container <https://hub.docker.com/r/agbase/combine_gafs>`_ 

The container can be pulled with this command: 

.. code-block:: bash

    singularity pull docker://agbase/combine_gafs:1.0
 
**Running Combine GAFs with Data**
^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    
Combine GAFs has three parameters:

.. code-block:: bash

    -i InterProScan XML Parser GAF output
    -g GOanna GAF output
    -o output file basename

**Example PBS Script**
""""""""""""""""""""""

.. code-block:: bash

    #!/bin/bash
    #PBS -N combine_gafs
    #PBS -W group_list=fionamcc
    #PBS -l select=1:ncpus=28:mem=168gb
    #PBS -q standard
    #PBS -l walltime=6:0:0
    #PBS -l cput=168:0:0
    
    module load singularity
    
    cd /rsgrps/shaneburgess/amanda/i5k/combine_gafs
    
    singularity pull docker://agbase/combine_gafs:1.0
    
    singularity run \
    -B /rsgrps/shaneburgess/amanda/i5k/combine_gafs:/work-dir \
    combine_gafs_1.0.sif \
    -i CFLO_1.fa_gaf.txt \
    -g clfo1_v_insecta_goanna_gaf.tsv \
    -o complete_gaf

**Breakdown of Command**
""""""""""""""""""""""""

**singularity run:** tells Singularity to run

**-B /rsgrps/shaneburgess/amanda/i5k/combine_gafs:/work-dir:** mounts my current working directory on the host machine to '/work-dir' in the container

**combine_gafs_1.0.sif:** the name of the Singularity image file to use

.. tip::

    All the options supplied after the image name are GOanna options

**-i CFLO_1.fa_gaf.txt:** InterProScan XML Parser GAF output file.

**-g clfo1_v_insecta_goanna_gaf.tsv:** GOanna GAF output file.

**-o complete_gaf:** output file basename--a .tsv extension will be added 


.. |find_combine_gafs| image:: ../img/find_combine_gafs.png
  :width: 700

.. |combine_gafs| image:: ../img/combine_gafs.png
  :width: 700